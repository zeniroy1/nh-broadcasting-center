/** Baseline1 v1 (2025-09-02)
/******************************************************
 * 1ë²ˆ(ì—…ë¬´ì¼ì§€) â†’ 2ë²ˆ(ë³¸ê´€/ì‹ ê´€) ë™ê¸°í™”
 * + ì‚¬ì§„ í¬ë§· í™•ì¥(ë¸”ë¡ ë³µì œ)
 * + ë ˆí„°ë°•ìŠ¤(ì›” êµ¬ë¶„ / ì›” ë³´ìˆ˜) ì‚½ì…Â·ì œê±°
 * + ì‚¬ì§„ì—…ë¡œë“œ(K1:N1, ID/ë§í¬ í˜¼ìš©)
 * ----------------------------------------------------
 * 2025-08-27
 *  - ë ˆí„°ë°•ìŠ¤ ì•„ë˜ ì²« ë¸”ë¡ ì‹œì‘ ìœ„ì¹˜ r+2 ë³´ì •
 *  - Bì—´ ì”ì„ (ìœ„/ì•„ë˜ í°ì„ ) ìœ ì§€, ì œê±° ì‹œ ìœ„ ì‚¬ì§„ì¹¸ ìœ—ë³€ ë³µêµ¬
 *  - âš™ A1:J1 ê¸€ì”¨ í¬ê¸° ìë™ ì ìš© ì œì™¸(ìš”ì²­ì‚¬í•­)
 ******************************************************/

/* =========================
 * ê¸°ë³¸ ì„¤ì •
 * ========================= */
const CONFIG = {
  SOURCE_SPREADSHEET_ID: '1SWehj9GwUfeAAnVXIx4OYrUxX6JF54CFn09rNb76YsE',
  SOURCE_SHEET_NAMES: ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'],
  TARGET_SHEET_BY_BUILDING: { 'ë³¸ê´€': '2. ë³¸ê´€ ë°©ì†¡ìš´ì˜ ìƒì„¸', 'ì‹ ê´€': '3. ì‹ ê´€ ë°©ì†¡ìš´ì˜ ìƒì„¸' },
  SRC_COL: { TIME:3, PLACE:4, SUBJECT:5, DEPT:6, HEAD:7 },
  TARGET_HEADER_ROWS: 2,
  TIMEZONE: 'Asia/Seoul',
  FONT_FAMILY: 'Malgun Gothic',
  FONT_SIZE: 9
};
const CONFIG_UI = { USE_TOAST: false };

/* =========================
 * ì‚¬ì§„ í¬ë§·
 * ========================= */
const PHOTO_INPUT = {
  SLOT_NAME: {
    B:  'ì‚¬ì§„ìŠ¬ë¡¯_ë³¸ê´€',
    S:  'ì‚¬ì§„ìŠ¬ë¡¯_ì‹ ê´€',
    MB: 'ì‚¬ì§„ìŠ¬ë¡¯_ë³¸ê´€_ë³´ìˆ˜',
    MS: 'ì‚¬ì§„ìŠ¬ë¡¯_ì‹ ê´€_ë³´ìˆ˜'
  },
  SECOND_COL_OFFSET: 2 // A â†’ C
};

/* =========================
 * ë ˆí„°ë°•ìŠ¤ ì •ì˜
 * ========================= */
const MONTH_HEADER = {
  MAIN_TEXT:  'ì›” ì£¼ìš” íšŒì˜/í–‰ì‚¬',
  MAINT_TEXT: 'ì›” ë³´ìˆ˜ ë° ì‚¬ìš©ë¶ˆëŠ¥ & ì¥ì•  ì˜ˆë°© í™œë™',
  WIDTH_COLS: 3,   // A:C
  HDR_HEIGHT: 48,  // ìœ—í–‰ ê³ ì •
  SPC_HEIGHT: 20   // ì•„ë«í–‰ ê³ ì •
};
const COLORS = {
  BLACK:'#000000', WHITE:'#ffffff', RED:'#ff0022',
  FONT_MAIN:'#ff0022', FONT_MAINT:'#000000'
};

/* =========================
 * ë©”ë‰´
 * ========================= */
function onOpen(){
  try { if (SpreadsheetApp.getActive().getId() === CONFIG.SOURCE_SPREADSHEET_ID) return; } catch(e){}

  SpreadsheetApp.getUi()
    .createMenu('ğŸ“¡ ë°©ì†¡ì—…ë¬´ì¼ì§€ ì—°ë™')
      .addItem('ì£¼ê°„(ì›”~ê¸ˆ)', 'sync_week_all')
      .addItem('ì˜¤ëŠ˜(ì˜¤ëŠ˜ë‚ ì§œ)', 'sync_today_only')
      .addToUi();

  SpreadsheetApp.getUi()
    .createMenu('ğŸ§© ì‚¬ì§„í‹€')
      .addItem('ì‚¬ì§„í‹€ 1ê°œ', 'photoFormat_cloneBlockOnceHere')
      .addItem('ì‚¬ì§„í‹€ 100ê°œ', 'photoFormat_cloneBlock100Here')
      .addSeparator()
      .addItem('ë ˆí„°ë°•ìŠ¤(ì‚¬ì§„ì² )', 'photoFormat_insertMonthHeaderHere')
      .addItem('ë ˆí„°ë°•ìŠ¤(ë³´ìˆ˜,ì ê²€)', 'photoFormat_insertMaintenanceHeaderHere')
      .addItem('ë ˆí„°ë°•ìŠ¤ ì œê±°', 'photoFormat_removeMonthHeaderHere')
      .addToUi();

  SpreadsheetApp.getUi()
    .createMenu('â–¶ ì‚¬ì§„ì—…ë¡œë“œ')
      .addItem('ì‹¤í–‰', 'simplePhotoUpload_fillFromInput')
      .addToUi();
}

/* =========================
 * â”€â”€ ë™ê¸°í™”(ìš”ì•½) â”€â”€
 * ========================= */
function sync_today_only(){
  const YOIL = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const today = YOIL[new Date().getDay()];
  if (!CONFIG.SOURCE_SHEET_NAMES.includes(today)) {
    SpreadsheetApp.getUi().alert(`ì—…ë¬´ì¼ì§€ íƒ­ì€ í‰ì¼ë§Œ ì¡´ì¬í•©ë‹ˆë‹¤. (ì˜¤ëŠ˜: ${today})`);
    return;
  }
  sync_core_([today]);
}
function sync_week_all(){ sync_core_(CONFIG.SOURCE_SHEET_NAMES); }

function sync_core_(sheetNames){
  if (SpreadsheetApp.getActive().getId() === CONFIG.SOURCE_SPREADSHEET_ID) {
    throw new Error('ì´ ì½”ë“œëŠ” 2ë²ˆ íŒŒì¼ì—ì„œë§Œ ì‹¤í–‰í•˜ì„¸ìš”. 1ë²ˆ íŒŒì¼ì€ ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤.');
  }
  ensure_target_sheets_exist_();

  const srcSS = SpreadsheetApp.openById(CONFIG.SOURCE_SPREADSHEET_ID);
  const stats = {};
  Object.keys(CONFIG.TARGET_SHEET_BY_BUILDING).forEach(k => stats[k] = {written:0, left:0});

  sheetNames.forEach(name=>{
    const sh = srcSS.getSheetByName(name);
    if (!sh) return;
    const dateInfo = extract_date_from_sheet_(sh);
    if (!dateInfo) return;
    const {month, day} = dateInfo;

    const sections = read_sections_from_source_(sh); // {ë³¸ê´€:[], ì‹ ê´€:[]}
    Object.keys(CONFIG.TARGET_SHEET_BY_BUILDING).forEach(b=>{
      const rows = sections[b] || [];
      const {written, left} = upsert_one_day_noinsert_(b, month, day, rows);
      stats[b].written += written;
      stats[b].left    += left;
    });
  });

  Object.values(CONFIG.TARGET_SHEET_BY_BUILDING).forEach(apply_sheet_font_);
  showSyncReport_(stats);
}

/* â”€â”€ ë™ê¸°í™” ìœ í‹¸ â”€â”€ */
function ensure_target_sheets_exist_(){
  const ss = SpreadsheetApp.getActive();
  Object.values(CONFIG.TARGET_SHEET_BY_BUILDING).forEach(n=>{
    if (!ss.getSheetByName(n)) throw new Error('íƒ€ê¹ƒ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + n);
  });
}
function extract_date_from_sheet_(sh){
  const vals = sh.getRange(1,1,Math.min(sh.getLastRow(),20), Math.min(sh.getLastColumn(),15)).getDisplayValues();
  for (let r=0;r<vals.length;r++){
    for (let c=0;c<vals[r].length;c++){
      const s = String(vals[r][c]||'');
      const m = s.match(/(\d{4})\s*ë…„\s*(\d{1,2})\s*ì›”\s*(\d{1,2})\s*ì¼/);
      if (m) return {year:+m[1], month:+m[2], day:+m[3]};
    }
  }
  return null;
}
const _t  = s => (s==null ? '' : String(s).trim());
const _tc = s => _t(s).replace(/\s+/g,'');
const firstLine_ = s => _t(String(s||'').split(/[\r\n\u000b\u2028\u2029]/)[0]);
const normKey_ = s => _t(s).toLowerCase().replace(/\s+/g,'');
const TIME_RE = /^\d{2}:\d{2}\s*~\s*\d{2}:\d{2}$/;

function splitSubjectAndTitle_(s){
  const first = firstLine_(s);
  const m = first.match(/\(([^()]*)\)\s*$/);
  if (m) return { subject: first.slice(0, m.index).trim(), title: m[1].trim() };
  return { subject: first, title: '' };
}
function read_sections_from_source_(sh){
  const out = {'ë³¸ê´€':[], 'ì‹ ê´€':[]};
  const lastRow = sh.getLastRow();
  if (lastRow < 1) return out;

  const aRange = sh.getRange(1,1,lastRow,1);
  const aVals  = aRange.getDisplayValues().map(r=>r[0]||'');
  const merges = aRange.getMergedRanges();

  const sections = [];
  merges.forEach(m=>{
    if (m.getColumn()!==1) return;
    const label = _tc(m.getDisplayValue());
    if (label==='ë³¸ê´€' || label==='ì‹ ê´€')
      sections.push({type:label, start:m.getRow(), end:m.getRow()+m.getNumRows()-1});
  });

  function isInsideAny(r){ return sections.some(s => r>=s.start && r<=s.end); }
  for (let r=1;r<=lastRow;r++){
    const label = _tc(aVals[r-1]);
    if ((label==='ë³¸ê´€' || label==='ì‹ ê´€') && !isInsideAny(r)){
      let end = lastRow;
      for (let rr=r+1; rr<=lastRow; rr++){
        const l2 = _tc(aVals[rr-1]);
        if (l2==='ë³¸ê´€' || l2==='ì‹ ê´€'){ end = rr-1; break; }
      }
      sections.push({type:label, start:r, end});
    }
  }

  sections.sort((a,b)=> (a.start-b.start) || (a.end-b.end));
  const uniq = [];
  for (const s of sections){
    if (!uniq.length || uniq[uniq.length-1].start!==s.start || uniq[uniq.length-1].end!==s.end) uniq.push(s);
  }

  const {TIME:C, PLACE:D, SUBJECT:E, DEPT:F, HEAD:G} = CONFIG.SRC_COL;
  const headerTokens = new Set(['ì‹œê°„','ìš´ì˜ì‹œê°„','ì¥ì†Œ','íšŒì˜ì‹¤ëª…','íšŒì˜ë‚´ìš©','íšŒì˜ëª…','ì£¼ê´€ë¶€ì„œ','ì£¼ê´€íŒ€','ë‹´ë‹¹','ì¸ì›','ë¹„ê³ ','ì£¼ìš”ì•ˆë‚´ì‚¬í•­']);

  uniq.forEach(sec=>{
    const n = Math.max(0, sec.end-sec.start+1); if (!n) return;
    const rows = sh.getRange(sec.start, 1, n, Math.max(G,7)).getDisplayValues();

    let lastDept = '';
    const seen = new Set();
    for (let i=0;i<n;i++){
      const r = rows[i];
      const time = _t(r[C-1]);
      const place = _t(r[D-1]);
      const subjRaw = r[E-1];
      const {subject, title} = splitSubjectAndTitle_(subjRaw);
      let dept = _t(r[F-1]);
      const head = _t(r[G-1]);

      if (!dept) dept = lastDept; else lastDept = dept;

      if ([time,place,subject,dept,head].every(v=>!v)) continue;
      if ([time,place,subject,dept,head].some(x=>headerTokens.has(_tc(x)))) continue;
      if (!TIME_RE.test(time) || (!place && !subject)) continue;

      const key = [time, place, subject, dept].map(normKey_).join('|');
      if (seen.has(key)) continue; seen.add(key);

      out[sec.type].push({time, place, subject, title, dept, head});
    }
  });

  return out;
}
function format_headcount_(s){ const n=String(s||'').replace(/[^\d]/g,''); return n? n+'ëª…':''; }
function lastDataRowBJ_(sh){
  const hr=CONFIG.TARGET_HEADER_ROWS, max=sh.getLastRow();
  if (max<=hr) return hr;
  const vals=sh.getRange(hr+1, 2, max-hr, 9).getValues();
  for (let i=vals.length-1;i>=0;i--){
    if (vals[i].some(v => String(v).trim() !== '')) return hr + 1 + i;
  }
  return hr;
}
function copyTemplateFormatDJ_(sh,startRow,numRows){
  if (numRows<=0) return;
  const tplRow=Math.min(sh.getLastRow(), CONFIG.TARGET_HEADER_ROWS + 1) || (CONFIG.TARGET_HEADER_ROWS + 1);
  const src=sh.getRange(tplRow,4,1,7);  // D~J í…œí”Œë¦¿
  const dst=sh.getRange(startRow,4,numRows,7);
  src.copyTo(dst,{formatOnly:true});
}
function upsert_one_day_noinsert_(building,month,day,rows){
  const name=CONFIG.TARGET_SHEET_BY_BUILDING[building]; if(!name) return {written:0,left:rows.length};
  const sh=SpreadsheetApp.getActive().getSheetByName(name); if(!sh) throw new Error('íƒ€ê¹ƒ ì‹œíŠ¸ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: '+name);
  const hr=CONFIG.TARGET_HEADER_ROWS;

  const dataLast=lastDataRowBJ_(sh);
  const haveIdx=[];
  if (dataLast>hr){
    const bc=sh.getRange(hr+1,2,dataLast-hr,2).getValues();
    for (let i=0;i<bc.length;i++){
      const m=Number(String(bc[i][0]).replace(/[^\d]/g,'')); const d=Number(String(bc[i][1]).replace(/[^\d]/g,''));
      if (m===month && d===day) haveIdx.push(hr+1+i);
    }
  }
  const existingMap=new Map();
  haveIdx.forEach(idx=>{
    const v=sh.getRange(idx,4,1,4).getDisplayValues()[0]; // D,E,F,G
    const k=[v[0],v[1],v[2],v[3]].map(normKey_).join('|');
    if(!existingMap.has(k)) existingMap.set(k,[]);
    existingMap.get(k).push(idx);
  });

  const seen=new Set(); const filtered=[];
  rows.forEach(r=>{ const k=[r.time,r.place,r.subject,r.dept].map(normKey_).join('|'); if(!seen.has(k)){seen.add(k); filtered.push(r);} });

  let written=0; const used=new Set(); const append=[];
  filtered.forEach(r=>{
    const k=[r.time,r.place,r.subject,r.dept].map(normKey_).join('|');
    const targets=(existingMap.get(k)||[]).filter(i=>!used.has(i));
    const meetingType = r.title && r.title.trim() ? 'ì£¼ìš”íšŒì˜':'ì¼ë°˜íšŒì˜';
    const payload=[month,day,r.time,r.place,r.subject,r.dept,format_headcount_(r.head),r.title||'',meetingType];
    if (targets.length){ const idx=targets[0]; sh.getRange(idx,2,1,9).setValues([payload]); used.add(idx); written++; }
    else append.push(payload);
  });

  let left=0;
  if (append.length){
    const start=lastDataRowBJ_(sh)+1;
    const canWrite=Math.max(0, sh.getLastRow()-start+1);
    const n=Math.min(canWrite, append.length);
    if (n>0){ copyTemplateFormatDJ_(sh,start,n); sh.getRange(start,2,n,9).setValues(append.slice(0,n)); written+=n; }
    left = append.length - n;
  }
  haveIdx.forEach(i=>{ if(!used.has(i)) sh.getRange(i,2,1,9).clearContent(); });

  return {written,left};
}

/* âš™ í°íŠ¸ ì ìš©: A1:J1ì€ ê¸€ì”¨ 'í¬ê¸°' ì œì™¸(ìë™ 9pt ë°©ì§€) */
function apply_sheet_font_(name){
  const sh = SpreadsheetApp.getActive().getSheetByName(name);
  if (!sh) return;

  const lr = Math.max(1, sh.getLastRow());
  const lc = Math.max(1, sh.getLastColumn());

  // 1) í°íŠ¸ íŒ¨ë°€ë¦¬ëŠ” ì „ì²´ì— ì¼ê´„ ì ìš©
  sh.getRange(1,1,lr,lc).setFontFamily(CONFIG.FONT_FAMILY);

  // 2) í°íŠ¸ í¬ê¸°(9pt)ëŠ” A1:J1ì„ ì œì™¸í•˜ê³  ì ìš©
  if (lr >= 2) {
    // 2-1) 2í–‰~ë
    sh.getRange(2,1,lr-1,lc).setFontSize(CONFIG.FONT_SIZE);
  }
  if (lc > 10) {
    // 2-2) 1í–‰ì˜ K~ë
    sh.getRange(1,11,1,lc-10).setFontSize(CONFIG.FONT_SIZE);
  }
  // ğŸ‘‰ A1:J1(=1í–‰ 1~10ì—´)ì€ í¬ê¸° ë¯¸ì ìš© â†’ ì‚¬ìš©ìê°€ ë„£ì€ í¬ê¸°ë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€
}

/* =========================
 * â”€â”€ ì‚¬ì§„ í¬ë§· í™•ì¥ â”€â”€
 * ========================= */
function photoFormat_cloneBlockOnceHere(){ photoFormat_cloneBlocksRowPairHere_(1); }
function photoFormat_cloneBlock100Here(){ photoFormat_cloneBlocksRowPairHere_(100); }

function photoFormat_cloneBlocksRowPairHere_(count){
  const sh=SpreadsheetApp.getActiveSheet(), ui=SpreadsheetApp.getUi(), sel=sh.getActiveRange();
  if(!sel){ ui.alert('ë¨¼ì € ë³µì œí•  ë¸”ë¡ì˜ í•œ ì¹¸ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.'); return; }

  const slotName =
    (sh.getName().indexOf('ë³¸ê´€')>-1 && sh.getName().indexOf('ë³´ìˆ˜')>-1) ? PHOTO_INPUT.SLOT_NAME.MB :
    (sh.getName().indexOf('ì‹ ê´€')>-1 && sh.getName().indexOf('ë³´ìˆ˜')>-1) ? PHOTO_INPUT.SLOT_NAME.MS :
    (sh.getName().indexOf('ë³¸ê´€')>-1) ? PHOTO_INPUT.SLOT_NAME.B :
    (sh.getName().indexOf('ì‹ ê´€')>-1) ? PHOTO_INPUT.SLOT_NAME.S : null;

  if(!slotName){ ui.alert('ì´ ê¸°ëŠ¥ì€ ë³¸ê´€/ì‹ ê´€ (ì‚¬ì§„)Â·(ë³´ìˆ˜ì ê²€) ì‹œíŠ¸ì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }

  const base=sh.getParent().getRangeByName(slotName);
  if(!base || base.getSheet().getSheetId()!==sh.getSheetId()){ ui.alert('ì´ë¦„ë²”ìœ„ "'+slotName+'" (ì²« ì‚¬ì§„ì¹¸ 1ì¹¸)ë¶€í„° ì„¤ì •í•˜ì„¸ìš”.'); return; }
  if(base.getNumRows()!==1 || base.getNumColumns()!==1){ ui.alert('ì´ë¦„ë²”ìœ„ "'+slotName+'" ì€ 1ì¹¸ì´ì–´ì•¼ í•©ë‹ˆë‹¤.'); return; }

  const r0=base.getRow(), cL=base.getColumn(), cR=cL+(PHOTO_INPUT.SECOND_COL_OFFSET||2), STEP=3;
  let top=sel.getRow(); top = top - ((top - r0) % STEP);
  if (LB_isHeaderRow_(sh, top, cL, cR)){ ui.alert('ë ˆí„°ë°•ìŠ¤ í–‰ì—ì„œëŠ” ë³µì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const tplL=sh.getRange(top,cL,STEP,1), tplR=sh.getRange(top,cR,STEP,1);
  const insertAfter = top + STEP - 1;
  sh.insertRowsAfter(insertAfter, STEP * count);

  for(let i=0;i<count;i++){
    for(let r=0;r<STEP;r++){
      const h=sh.getRowHeight(top+r);
      sh.setRowHeight(insertAfter + (i*STEP) + 1 + r, h);
    }
    const dstRow = insertAfter + 1 + (i*STEP);
    const dstL = sh.getRange(dstRow, cL, STEP, 1); tplL.copyTo(dstL,{formatOnly:true}); dstL.clearContent();
    const dstR = sh.getRange(dstRow, cR, STEP, 1); tplR.copyTo(dstR,{formatOnly:true}); dstR.clearContent();
  }

  // ì”ì„ : ì¶”ê°€ì˜ì—­ì˜ Bì—´ì€ ìœ„/ì•„ë˜ í°ì„ 
  PF_whitenColumnB_(sh, insertAfter+1, insertAfter + STEP*count);

  ui.alert(`ë¸”ë¡ì„ ì•„ë˜ë¡œ ${count}ê°œ(ê°ê° A/C í•œ ìŒ) ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
}

// Bì—´ ì”ì„ ì€ ìœ„Â·ì•„ë˜ë§Œ í°ì„  ì²˜ë¦¬(ì¢Œ/ìš°ëŠ” ë³€ê²½í•˜ì§€ ì•ŠìŒ)
function PF_whitenColumnB_(sheet, rowFrom, rowTo){
  if (rowTo < rowFrom) return;
  sheet.getRange(rowFrom,2,rowTo-rowFrom+1,1)
       .setBorder(true, null, true, null, null, null, COLORS.WHITE, SpreadsheetApp.BorderStyle.SOLID);
}

/* =========================
 * â”€â”€ ë ˆí„°ë°•ìŠ¤ ì‚½ì…/ì œê±° â”€â”€
 * ========================= */
function LB_norm_(s){ return String(s||'').toLowerCase().replace(/\s+/g,'').replace(/[&/\\()]/g,''); }
function PUP_isLetterboxTopRow_(sh, row){
  const vals = sh.getRange(row,1,1,3).getDisplayValues()[0].join(' ');
  const t = LB_norm_(vals);
  return t.includes(LB_norm_(MONTH_HEADER.MAIN_TEXT)) ||
         (t.includes('ì›”ë³´ìˆ˜') && (t.includes('ì¥ì• ì˜ˆë°©') || t.includes('ì‚¬ìš©ë¶ˆëŠ¥')));
}
function LB_isHeaderRow_(sheet, row, cL, cR){
  const cells=[sheet.getRange(row,cL), sheet.getRange(row,cR)];
  for (let i=0;i<cells.length;i++){
    try{
      const cell=cells[i]; if(!cell.isPartOfMerge()) continue;
      const merged=cell.getMergedRanges()[0];
      if(merged && merged.getNumRows()===1 && merged.getNumColumns()>=MONTH_HEADER.WIDTH_COLS){
        const t=LB_norm_(merged.getDisplayValue());
        if (t.includes(LB_norm_(MONTH_HEADER.MAIN_TEXT))) return true;
        if (t.includes('ì›”ë³´ìˆ˜') && (t.includes('ì¥ì• ì˜ˆë°©') || t.includes('ì‚¬ìš©ë¶ˆëŠ¥'))) return true;
      }
    }catch(_){}
  }
  return false;
}

// ìŠ¤í˜ì´ì„œ ë³´ë”: A/CëŠ” 4ë©´ ê²€ì • í›„ â†’ A:ì˜¤ë¥¸ìª½ í°ì„  / C:ì™¼ìª½+ì˜¤ë¥¸ìª½ í°ì„ .
// BëŠ” top/bottomë§Œ í°ì„ .
function LB_paintSpacerRowBorders_(sheet, spacerRow){
  const A = sheet.getRange(spacerRow,1,1,1);
  const B = sheet.getRange(spacerRow,2,1,1);
  const C = sheet.getRange(spacerRow,3,1,1);

  [A,C].forEach(r=>{
    r.setBorder(true,true,true,true,false,false,COLORS.BLACK,SpreadsheetApp.BorderStyle.SOLID);
  });

  // A : ì˜¤ë¥¸ìª½ë§Œ í°ì„ 
  A.setBorder(null, null, null, true, null, null, COLORS.WHITE, SpreadsheetApp.BorderStyle.SOLID);

  // C : ì™¼ìª½ + ì˜¤ë¥¸ìª½ í°ì„ 
  C.setBorder(null, true, null, true, null, null, COLORS.WHITE, SpreadsheetApp.BorderStyle.SOLID);

  // B : ìœ„/ì•„ë˜ë§Œ í°ì„ 
  B.setBorder(true, null, true, null, null, null, COLORS.WHITE, SpreadsheetApp.BorderStyle.SOLID);
}

function LB_paintHeaderBorders_(hdrRange){
  hdrRange.setBorder(true,true,true,true,false,false,COLORS.BLACK,SpreadsheetApp.BorderStyle.SOLID);
}

// ê³µí†µ ì‚½ì… ì½”ì–´
function LB_insertHeaderCore_(text, fontColor){
  const sh=SpreadsheetApp.getActiveSheet();
  const sel=sh.getActiveRange()||sh.getRange('A1');

  const insertBelow = sel.getLastRow();
  sh.insertRowsAfter(insertBelow, 2);

  const headerRow = insertBelow + 1;
  const spacerRow = insertBelow + 2;

  try{ sh.setRowHeight(headerRow, MONTH_HEADER.HDR_HEIGHT); sh.setRowHeight(spacerRow, MONTH_HEADER.SPC_HEIGHT); }catch(_){}
  sh.getRange(headerRow,1,1,MONTH_HEADER.WIDTH_COLS).breakApart();
  sh.getRange(spacerRow,1,1,MONTH_HEADER.WIDTH_COLS).breakApart();

  const letterBg = sh.getRange(1,1).getBackground() || '#e0e0e0';
  const hdr = sh.getRange(headerRow,1,1,MONTH_HEADER.WIDTH_COLS).merge();
  hdr.setBackground(letterBg).setFontFamily('Arial').setFontSize(14).setFontStyle('normal') .setFontColor(fontColor)
     .setHorizontalAlignment('center').setVerticalAlignment('middle').setValue(text);

  sh.getRange(spacerRow,1,1,MONTH_HEADER.WIDTH_COLS).setBackground(null);
  LB_paintSpacerRowBorders_(sh, spacerRow);
  LB_paintHeaderBorders_(hdr);
  hdr.setBorder(null,null,true,null,null,null,COLORS.BLACK,SpreadsheetApp.BorderStyle.SOLID); // ì•„ë˜ ë³´ê°•

  // í—¤ë”/ìŠ¤í˜ì´ì„œ ë‘ í–‰ì˜ Bì—´ ì”ì„ : top/bottomë§Œ í°ì„ 
  PF_whitenColumnB_(sh, headerRow, spacerRow);

  SpreadsheetApp.getUi().alert('ë ˆí„°ë°•ìŠ¤ë¥¼ ì‚½ì…í–ˆìŠµë‹ˆë‹¤.');
}
function photoFormat_insertMonthHeaderHere(){ LB_insertHeaderCore_(MONTH_HEADER.MAIN_TEXT, COLORS.FONT_MAIN); }
function photoFormat_insertMaintenanceHeaderHere(){ LB_insertHeaderCore_(MONTH_HEADER.MAINT_TEXT, COLORS.FONT_MAINT); }

/* --- ë ˆí„°ë°•ìŠ¤ ì œê±° (ë³´ì • í¬í•¨) --- */
function photoFormat_removeMonthHeaderHere(){
  const sh=SpreadsheetApp.getActiveSheet();
  const row=(sh.getActiveRange()||sh.getRange('A1')).getRow();

  const mergedList = sh.getRange(row,1,1,MONTH_HEADER.WIDTH_COLS).getMergedRanges();
  if (!mergedList.length){ SpreadsheetApp.getUi().alert('ì„ íƒí•œ í–‰ì´ ë ˆí„°ë°•ìŠ¤(ë³‘í•©í–‰)ê°€ ì•„ë‹™ë‹ˆë‹¤.'); return; }
  const merged = mergedList[0];

  const t=LB_norm_(merged.getDisplayValue());
  const ok = t.includes(LB_norm_(MONTH_HEADER.MAIN_TEXT)) ||
             (t.includes('ì›”ë³´ìˆ˜') && (t.includes('ì¥ì• ì˜ˆë°©')||t.includes('ì‚¬ìš©ë¶ˆëŠ¥')));
  if(!ok){ SpreadsheetApp.getUi().alert('ê¸°ë³¸ ë¬¸êµ¬ê°€ í¬í•¨ë˜ì§€ ì•Šì•„ ì‚­ì œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'); return; }

  // ì‚­ì œ (í—¤ë”â†’ìŠ¤í˜ì´ì„œ)
  sh.deleteRow(row);
  sh.deleteRow(row);

  // ì•„ë˜ ì‚¬ì§„ì¹¸ ìœ— ì‹¤ì„  ë³µêµ¬ + B top/bottom í°ì„ 
  LB_restoreTopBorderAfterRemove_(sh, row);

  SpreadsheetApp.getUi().alert('ë ˆí„°ë°•ìŠ¤(2í–‰)ë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤.');
}
function LB_restoreTopBorderAfterRemove_(sheet, imgRow){
  if (imgRow > sheet.getLastRow()) return;

  const A = sheet.getRange(imgRow,1,1,1);
  const B = sheet.getRange(imgRow,2,1,1);
  const C = sheet.getRange(imgRow,3,1,1);

  // A/C : ìœ—ë³€ë§Œ ê²€ì • ì‹¤ì„  ë³µêµ¬
  A.setBorder(true, null, null, null, null, null, COLORS.BLACK, SpreadsheetApp.BorderStyle.SOLID);
  C.setBorder(true, null, null, null, null, null, COLORS.BLACK, SpreadsheetApp.BorderStyle.SOLID);

  // B : top/bottomë§Œ í°ì„ 
  B.setBorder(true, null, true, null, null, null, COLORS.WHITE, SpreadsheetApp.BorderStyle.SOLID);
}

/* =========================================================
 * â–¶ ì‚¬ì§„ì—…ë¡œë“œ (K1:N1 â†’ A/C, ë§ˆì§€ë§‰ ë ˆí„°ë°•ìŠ¤ ì•„ë˜ì—ì„œ ì‹œì‘)
 * ========================================================= */
function simplePhotoUpload_fillFromInput() {
  const sh=SpreadsheetApp.getActiveSheet(), ui=SpreadsheetApp.getUi();

  const idsRaw=sh.getRange('K1:N1').getValues()[0];
  const ids=idsRaw.map(v=>PUP_extractDriveId(String(v||''))).filter(Boolean);
  if(!ids.length){ ui.alert('K1:N1ì— ìœ íš¨í•œ êµ¬ê¸€ ë§í¬ ë˜ëŠ” IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

  // ğŸ”§ ë ˆí„°ë°•ìŠ¤ ë°”ë¡œ ì•„ë˜ ì²« ë¸”ë¡: r + 2 (í—¤ë”1 + ìŠ¤í˜ì´ì„œ1)
  const startFrom = PUP_forceBelowLetterbox_(sh, 2);
  let cursor = Math.max(3, startFrom);

  const placed=[];
  ids.forEach(id=>{
    const slot=PUP_findNextFreeSlot_(sh,cursor); if(!slot) throw new Error('ë¹ˆ ìŠ¬ë¡¯ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¸”ë¡ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');

    const img=sh.getRange(slot.row,slot.col);
    const tit=sh.getRange(slot.row+1,slot.col);
    const idc=sh.getRange(slot.row+2,slot.col);

    idc.setValue(id).setFontColor(COLORS.WHITE);
    img.setFormula(`=IMAGE("https://drive.google.com/uc?export=download&id=" & ${idc.getA1Notation()}, 2)`);

    try{ sheetResizeForPhoto_(sh); }catch(_){}

    if(String(tit.getValue()||'').trim()==='') tit.setValue('í–‰ì‚¬ ì œëª©');

    placed.push(`${img.getA1Notation()} (ID=${id})`);
    cursor = slot.nextStart;
  });

  ui.alert(`ì´ ${placed.length}ê°œ ì—…ë¡œë“œ ì™„ë£Œ\n`+placed.join('\n'));
  sh.getRange('K1:N1').clearContent();
}
function sheetResizeForPhoto_(sh){
  try{
    sh.setColumnWidth(1,280); // A
    sh.setColumnWidth(3,280); // C
  }catch(_){}
}
function PUP_forceBelowLetterbox_(sh,jump){
  const last=sh.getLastRow();
  for(let r=last;r>=1;r--){
    if(PUP_isLetterboxTopRow_(sh,r)) return r + Math.max(2, jump|0); // r+2
  }
  return 3;
}
function PUP_findNextFreeSlot_(sh,startRow){
  const lastRow=Math.max(sh.getMaxRows(),startRow);
  let r=Math.max(3,startRow); const colA=1,colC=3;
  while(r<=lastRow){
    if(PUP_isLetterboxTopRow_(sh,r)){ r+=2; continue; } // í—¤ë”/ìŠ¤í˜ì´ì„œ ìŠ¤í‚µ
    if(!PUP_isBlockUsed_(sh,r,colA)) return {row:r,col:colA,nextStart:r};
    if(!PUP_isBlockUsed_(sh,r,colC)) return {row:r,col:colC,nextStart:r+3};
    r+=3;
  }
  return null;
}
function PUP_isBlockUsed_(sh,row,col){
  const idc=sh.getRange(row+2,col), img=sh.getRange(row,col), tit=sh.getRange(row+1,col);
  const idv=String(idc.getValue()||'').trim(), fm=String(img.getFormula()||'').trim(),
        dv=String(img.getDisplayValue()||'').trim(), tv=String(tit.getValue()||'').trim();
  const hasOverlay = (()=>{ try{ return sh.getImages().some(im=>{const a=im.getAnchorCell(); return a&&a.getRow()===row&&a.getColumn()===col;}); }catch(_){ return false; }})();
  return !!(idv || /^=IMAGE\(/i.test(fm) || dv || hasOverlay || tv);
}
function PUP_extractDriveId(str){
  if(!str) return '';
  let m=str.match(/\/d\/([A-Za-z0-9_-]{25,})/); if(m) return m[1];
  m=str.match(/[?&]id=([A-Za-z0-9_-]{25,})/);   if(m) return m[1];
  return /^[A-Za-z0-9_-]{25,40}$/.test(str) ? str : '';
}

/* =========================
 * ê³µí†µ ìœ í‹¸
 * ========================= */
function showSyncReport_(stats){
  const lines = Object.keys(CONFIG.TARGET_SHEET_BY_BUILDING).map(b=>{
    const s = stats[b] || {written:0, left:0};
    return `${b} â€” ê¸°ë¡: ${s.written||0}ê±´  ë¯¸ê¸°ë¡: ${s.left||0}ê±´`;
  });
  const msg = lines.join('\n');
  SpreadsheetApp.getUi().alert(msg);
  if (CONFIG_UI.USE_TOAST) SpreadsheetApp.getActive().toast(msg, 'ë™ê¸°í™” ê²°ê³¼', 5);
}